I will read the existing `anti_cheat.yaml` to see if it needs to be updated or if I should create a new one.
I will list the files in the `agents/skills` directory to verify the existence of `anti_cheat.yaml`.
I will read the content of `agents/skills/anti_cheat.yaml`.
I will read the content of `AGENTS.md` to check if the `read_file` tool is working correctly.
I will use `cat` to read the content of `agents/skills/anti_cheat.yaml` to verify its contents.
I will read `agents/skills/audio_visual.yaml` to see if other skill files have the same issue.
I will read `agents.yaml` to see if it references the skill files.
I will read `agents/skills/mobile_build.yaml` to ensure I have all the correct schema keys.
name: iaido-anti-cheat
version: 0.1.0
description: >-
  Enforces game integrity by validating input timing, ensuring deterministic state transitions, 
  and detecting anomalies like pre-GO inputs, timestamp tampering, and replay mismatches.
assumptions:
  - Game logic is strictly deterministic and uses a monotonic clock (engine time).
  - Input events are captured with high-resolution timestamps.
  - Initial RNG seeds are logged per match.
prerequisites:
  - rustc >= 1.75
  - bevy >= 0.13
non_goals:
  - Server-side authoritative validation (MVP is local-first).
  - Anti-tamper/obfuscation of the executable.
  - Encrypted storage for high scores.
capabilities:
  - Input Gating: Ignore or penalize inputs before the GO signal.
  - Timing Validation: Ensure reaction times are physically possible and monotonically increasing.
  - Replay Consistency: Verify that re-simulating the same inputs and seed yields identical outcomes.
inputs:
  - input_sequence: List of (direction, timestamp)
  - start_seed: u64
  - go_timestamp: u64
outputs:
  - integrity_status: [VALID, TAMPERED, FOUL]
  - validation_report: Detailed log of timing discrepancies or state mismatches.
environment:
  IAIDO_STRICT_DETERMINISM: "true"
  IAIDO_MIN_REACTION_MS: "50"
os_permissions: []
platform_entitlements: []
tools:
  - cargo
commands:
  run_replay_test:
    exec: cargo test --test replay_integrity
tasks:
  - name: input_gating_enforcement
    description: Lock input until GO_SIGNAL and detect pre-emptive strikes.
    steps:
      - Monitor `DuelState` transitions.
      - Reject any `SwipeEvent` received during `STANDOFF` or `RANDOM_DELAY`.
      - Transition to `LOSS_FOUL` if pre-GO input is detected.
  - name: timing_integrity_check
    description: Validate input timestamps against the monotonic clock.
    steps:
      - Ensure `input_timestamp >= go_timestamp`.
      - Calculate `reaction_time = input_timestamp - go_timestamp`.
      - Flag as `TAMPERED` if `reaction_time < IAIDO_MIN_REACTION_MS`.
  - name: determinism_verification
    description: Ensure the simulation remains deterministic across runs.
    steps:
      - Capture the initial `Rng` seed for each duel.
      - Log all `SwipeEvent` directions and relative timestamps.
      - Implement a `ReplayPlugin` that feeds logs into the `DuelStateMachine`.
      - Compare re-simulated `MatchResult` with the original.
  - name: state_transition_audit
    description: Audit state machine transitions for illegal jumps.
    steps:
      - Assert that `RESET` can only go to `STANDOFF`.
      - Assert that `RESOLUTION` can only be reached after `GO_SIGNAL`.
safety:
  - deterministic: No use of non-deterministic types (e.g., standard HashMaps without fixed seeds).
  - immutable_logs: Input logs are append-only during the match.
  - timing: Use engine-provided monotonic time exclusively.
observability:
  - Log `reaction_time` for every successful duel.
  - Log `Foul` events with sub-millisecond precision for debugging "accidental" early hits.
  - Metrics: Ratio of `TAMPERED` vs `VALID` matches.
validation:
  - unit_test: Verify `DuelStateMachine` rejects inputs in `STANDOFF`.
  - unit_test: Verify `ReplayPlugin` reproduces a known win/loss from a JSON log.
  - property_test: Run 10,000 duels with random inputs and verify replayer consistency.
done:
  - `AntiCheatPlugin` integrated into the main application.
  - Pre-GO inputs correctly trigger a "Foul" state.
  - Replay logs successfully validate deterministic matches.
rollback:
  - Disable `AntiCheatPlugin` in the Bevy `App` builder.
